<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç«¯åˆ°ç«¯åŠ å¯†é€šä¿¡æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .image-container {
            max-width: 300px;
            margin: 10px 0;
        }
        .image-container img {
            max-width: 100%;
            height: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>ğŸ” ç«¯åˆ°ç«¯åŠ å¯†é€šä¿¡æµ‹è¯•</h1>
    <p>æµ‹è¯•RSAå¯†é’¥åå•†ã€AESåŠ å¯†è§£å¯†ã€LSBå›¾ç‰‡éšå†™æœ¯çš„å®Œæ•´æµç¨‹</p>

    <!-- RSAå¯†é’¥å¯¹ç”Ÿæˆæµ‹è¯• -->
    <div class="test-section">
        <h2>1. RSAå¯†é’¥å¯¹ç”Ÿæˆæµ‹è¯•</h2>
        <button onclick="testRSAKeyGeneration()">ç”ŸæˆRSAå¯†é’¥å¯¹</button>
        <div id="rsa-result"></div>
    </div>

    <!-- AESåŠ å¯†è§£å¯†æµ‹è¯• -->
    <div class="test-section">
        <h2>2. AESåŠ å¯†è§£å¯†æµ‹è¯•</h2>
        <input type="text" id="text-to-encrypt" placeholder="è¾“å…¥è¦åŠ å¯†çš„æ–‡æœ¬" value="Hello, è¿™æ˜¯ä¸€æ¡æµ‹è¯•æ¶ˆæ¯! ğŸŒŸ">
        <button onclick="testAESEncryption()">åŠ å¯†/è§£å¯†æµ‹è¯•</button>
        <div id="aes-result"></div>
    </div>

    <!-- å›¾ç‰‡éšå†™æœ¯æµ‹è¯• -->
    <div class="test-section">
        <h2>3. å›¾ç‰‡éšå†™æœ¯æµ‹è¯•</h2>
        <input type="text" id="text-to-hide" placeholder="è¾“å…¥è¦éšè—çš„æ–‡æœ¬" value="è¿™æ˜¯ä¸€ä¸ªç§˜å¯†æ¶ˆæ¯ ğŸ­">
        <button onclick="testSteganography()">éšå†™/æå–æµ‹è¯•</button>
        <div id="stego-result"></div>
    </div>

    <!-- ç«¯åˆ°ç«¯åŠ å¯†é€šä¿¡å®Œæ•´æµç¨‹æµ‹è¯• -->
    <div class="test-section">
        <h2>4. ç«¯åˆ°ç«¯åŠ å¯†é€šä¿¡å®Œæ•´æµç¨‹æµ‹è¯•</h2>
        <input type="email" id="peer-email" placeholder="å¯¹æ–¹é‚®ç®±" value="test@example.com">
        <textarea id="message-content" placeholder="è¾“å…¥æ¶ˆæ¯å†…å®¹" rows="3">è¿™æ˜¯ä¸€æ¡ç«¯åˆ°ç«¯åŠ å¯†çš„æµ‹è¯•æ¶ˆæ¯ï¼Œæ”¯æŒä¸­æ–‡å’ŒEmoji ğŸ”’ğŸš€</textarea>
        <button onclick="testE2EEncryption()">å®Œæ•´æµç¨‹æµ‹è¯•</button>
        <div id="e2e-result"></div>
    </div>

    <!-- æ€§èƒ½æµ‹è¯• -->
    <div class="test-section">
        <h2>5. æ€§èƒ½æµ‹è¯•</h2>
        <button onclick="testPerformance()">è¿è¡Œæ€§èƒ½æµ‹è¯•</button>
        <div id="performance-result"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsencrypt/3.3.2/jsencrypt.min.js"></script>
    <script>
        // ç®€åŒ–ç‰ˆåŠ å¯†ç®¡ç†å™¨ï¼ˆç”¨äºæµ‹è¯•ï¼‰
        class TestEncryptionManager {
            constructor() {
                this.sessionKeys = new Map();
                this.initRSAKeys();
            }

            initRSAKeys() {
                try {
                    const encrypt = new JSEncrypt({ default_key_size: 1024 });
                    encrypt.getKey();
                    this.publicKey = encrypt.getPublicKey();
                    this.privateKey = encrypt.getPrivateKey();
                    this.keyPair = encrypt;
                    return true;
                } catch (error) {
                    console.error('RSAå¯†é’¥ç”Ÿæˆå¤±è´¥:', error);
                    return false;
                }
            }

            generateSessionKey(peerEmail) {
                const aesKey = CryptoJS.lib.WordArray.random(256/8).toString();
                this.sessionKeys.set(peerEmail, aesKey);
                return aesKey;
            }

            encryptText(text, aesKey) {
                return CryptoJS.AES.encrypt(text, aesKey).toString();
            }

            decryptText(encryptedText, aesKey) {
                const bytes = CryptoJS.AES.decrypt(encryptedText, aesKey);
                return bytes.toString(CryptoJS.enc.Utf8);
            }

            // ç®€åŒ–çš„LSBéšå†™æœ¯ï¼ˆä»…ç”¨äºæµ‹è¯•ï¼ŒçœŸå®é¡¹ç›®ä¸­åº”ä½¿ç”¨æ›´å®Œå–„çš„å®ç°ï¼‰
            async encodeTextInImage(text) {
                // åˆ›å»ºä¸€ä¸ªç®€å•çš„æµ‹è¯•å›¾ç‰‡ï¼ˆcanvasï¼‰
                const canvas = document.createElement('canvas');
                canvas.width = 100;
                canvas.height = 100;
                const ctx = canvas.getContext('2d');
                
                // å¡«å……éšæœºåƒç´ 
                const imageData = ctx.createImageData(100, 100);
                for (let i = 0; i < imageData.data.length; i += 4) {
                    imageData.data[i] = Math.floor(Math.random() * 256);     // R
                    imageData.data[i + 1] = Math.floor(Math.random() * 256); // G
                    imageData.data[i + 2] = Math.floor(Math.random() * 256); // B
                    imageData.data[i + 3] = 255; // A
                }
                
                // å°†æ–‡æœ¬ç¼–ç åˆ°è“è‰²é€šé“çš„LSB
                const textBytes = new TextEncoder().encode(text);
                const lenBytes = new Uint8Array(4);
                const len = textBytes.length;
                lenBytes[0] = (len >> 24) & 0xFF;
                lenBytes[1] = (len >> 16) & 0xFF;
                lenBytes[2] = (len >> 8) & 0xFF;
                lenBytes[3] = len & 0xFF;
                
                const allBytes = new Uint8Array(4 + textBytes.length);
                allBytes.set(lenBytes, 0);
                allBytes.set(textBytes, 4);
                
                // è½¬ä¸ºæ¯”ç‰¹æ•°ç»„
                const bits = [];
                for (let i = 0; i < allBytes.length; i++) {
                    for (let b = 7; b >= 0; b--) {
                        bits.push((allBytes[i] >> b) & 1);
                    }
                }
                
                // å°†æ¯”ç‰¹éšå†™åˆ°è“è‰²é€šé“
                for (let i = 0; i < bits.length && i * 4 + 2 < imageData.data.length; i++) {
                    const pixelIndex = i * 4 + 2; // è“è‰²é€šé“
                    imageData.data[pixelIndex] = (imageData.data[pixelIndex] & 0xFE) | bits[i];
                }
                
                ctx.putImageData(imageData, 0, 0);
                return canvas.toDataURL('image/png');
            }

            async decodeTextFromImage(imageBase64) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        
                        const imageData = ctx.getImageData(0, 0, img.width, img.height);
                        
                        // æå–é•¿åº¦ï¼ˆå‰32ä½ï¼‰
                        let len = 0;
                        for (let i = 0; i < 32; i++) {
                            const pixelIndex = i * 4 + 2; // è“è‰²é€šé“
                            const bit = imageData.data[pixelIndex] & 0x01;
                            len = (len << 1) | bit;
                        }
                        
                        // æå–æ–‡æœ¬æ•°æ®
                        const textBytes = new Uint8Array(len);
                        for (let i = 0; i < len; i++) {
                            let byte = 0;
                            for (let b = 0; b < 8; b++) {
                                const pixelIndex = (32 + i * 8 + b) * 4 + 2;
                                if (pixelIndex < imageData.data.length) {
                                    const bit = imageData.data[pixelIndex] & 0x01;
                                    byte = (byte << 1) | bit;
                                }
                            }
                            textBytes[i] = byte;
                        }
                        
                        const text = new TextDecoder().decode(textBytes);
                        resolve(text);
                    };
                    img.onerror = reject;
                    img.src = imageBase64;
                });
            }
        }

        const testManager = new TestEncryptionManager();

        function displayResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = message;
            element.appendChild(div);
        }

        function clearResults(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        function testRSAKeyGeneration() {
            clearResults('rsa-result');
            try {
                const success = testManager.initRSAKeys();
                if (success) {
                    displayResult('rsa-result', 'âœ… RSAå¯†é’¥å¯¹ç”ŸæˆæˆåŠŸ', 'success');
                    displayResult('rsa-result', `å…¬é’¥é•¿åº¦: ${testManager.publicKey.length} å­—ç¬¦`, 'info');
                    displayResult('rsa-result', `å…¬é’¥å‰100å­—ç¬¦: ${testManager.publicKey.substring(0, 100)}...`, 'info');
                } else {
                    displayResult('rsa-result', 'âŒ RSAå¯†é’¥å¯¹ç”Ÿæˆå¤±è´¥', 'error');
                }
            } catch (error) {
                displayResult('rsa-result', `âŒ é”™è¯¯: ${error.message}`, 'error');
            }
        }

        function testAESEncryption() {
            clearResults('aes-result');
            try {
                const text = document.getElementById('text-to-encrypt').value;
                const sessionKey = testManager.generateSessionKey('test@example.com');
                
                displayResult('aes-result', `ğŸ”‘ ç”Ÿæˆä¼šè¯å¯†é’¥: ${sessionKey.substring(0, 16)}...`, 'info');
                
                const encrypted = testManager.encryptText(text, sessionKey);
                displayResult('aes-result', `ğŸ”’ åŠ å¯†ç»“æœ: ${encrypted.substring(0, 50)}...`, 'info');
                
                const decrypted = testManager.decryptText(encrypted, sessionKey);
                displayResult('aes-result', `ğŸ”“ è§£å¯†ç»“æœ: ${decrypted}`, 'info');
                
                if (text === decrypted) {
                    displayResult('aes-result', 'âœ… AESåŠ å¯†è§£å¯†æµ‹è¯•æˆåŠŸ', 'success');
                } else {
                    displayResult('aes-result', 'âŒ AESåŠ å¯†è§£å¯†æµ‹è¯•å¤±è´¥', 'error');
                }
            } catch (error) {
                displayResult('aes-result', `âŒ é”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function testSteganography() {
            clearResults('stego-result');
            try {
                const text = document.getElementById('text-to-hide').value;
                
                displayResult('stego-result', `ğŸ“ åŸå§‹æ–‡æœ¬: ${text}`, 'info');
                
                const encodedImage = await testManager.encodeTextInImage(text);
                displayResult('stego-result', 'ğŸ­ æ–‡æœ¬å·²éšå†™åˆ°å›¾ç‰‡ä¸­', 'info');
                
                // æ˜¾ç¤ºéšå†™åçš„å›¾ç‰‡
                const imageContainer = document.createElement('div');
                imageContainer.className = 'image-container';
                imageContainer.innerHTML = `<img src="${encodedImage}" alt="éšå†™åçš„å›¾ç‰‡">`;
                document.getElementById('stego-result').appendChild(imageContainer);
                
                const decodedText = await testManager.decodeTextFromImage(encodedImage);
                displayResult('stego-result', `ğŸ” æå–çš„æ–‡æœ¬: ${decodedText}`, 'info');
                
                if (text === decodedText) {
                    displayResult('stego-result', 'âœ… å›¾ç‰‡éšå†™æœ¯æµ‹è¯•æˆåŠŸ', 'success');
                } else {
                    displayResult('stego-result', 'âŒ å›¾ç‰‡éšå†™æœ¯æµ‹è¯•å¤±è´¥', 'error');
                }
            } catch (error) {
                displayResult('stego-result', `âŒ é”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function testE2EEncryption() {
            clearResults('e2e-result');
            try {
                const peerEmail = document.getElementById('peer-email').value;
                const messageContent = document.getElementById('message-content').value;
                
                displayResult('e2e-result', 'ğŸš€ å¼€å§‹ç«¯åˆ°ç«¯åŠ å¯†é€šä¿¡æµ‹è¯•...', 'info');
                
                // 1. ç”Ÿæˆä¼šè¯å¯†é’¥
                const sessionKey = testManager.generateSessionKey(peerEmail);
                displayResult('e2e-result', `ğŸ”‘ æ­¥éª¤1: ç”Ÿæˆä¼šè¯å¯†é’¥`, 'info');
                
                // 2. æ„é€ æ¶ˆæ¯åŒ…
                const messagePacket = {
                    type: 'text',
                    content: messageContent,
                    timestamp: Date.now(),
                    sessionKey: sessionKey
                };
                const messageJson = JSON.stringify(messagePacket);
                displayResult('e2e-result', `ğŸ“¦ æ­¥éª¤2: æ„é€ æ¶ˆæ¯åŒ…`, 'info');
                
                // 3. AESåŠ å¯†
                const encryptedMessage = testManager.encryptText(messageJson, sessionKey);
                displayResult('e2e-result', `ğŸ”’ æ­¥éª¤3: AESåŠ å¯†å®Œæˆ`, 'info');
                
                // 4. å›¾ç‰‡éšå†™
                const steganographyImage = await testManager.encodeTextInImage(encryptedMessage);
                displayResult('e2e-result', `ğŸ­ æ­¥éª¤4: å›¾ç‰‡éšå†™å®Œæˆ`, 'info');
                
                // æ˜¾ç¤ºéšå†™å›¾ç‰‡
                const imageContainer = document.createElement('div');
                imageContainer.className = 'image-container';
                imageContainer.innerHTML = `<img src="${steganographyImage}" alt="åŠ å¯†éšå†™åçš„å›¾ç‰‡">`;
                document.getElementById('e2e-result').appendChild(imageContainer);
                
                // 5. è§£éšå†™
                const extractedEncryptedMessage = await testManager.decodeTextFromImage(steganographyImage);
                displayResult('e2e-result', `ğŸ” æ­¥éª¤5: å›¾ç‰‡è§£éšå†™å®Œæˆ`, 'info');
                
                // 6. AESè§£å¯†
                const decryptedMessageJson = testManager.decryptText(extractedEncryptedMessage, sessionKey);
                const decryptedMessagePacket = JSON.parse(decryptedMessageJson);
                displayResult('e2e-result', `ğŸ”“ æ­¥éª¤6: AESè§£å¯†å®Œæˆ`, 'info');
                
                // 7. éªŒè¯ç»“æœ
                displayResult('e2e-result', `ğŸ“ è§£å¯†åçš„æ¶ˆæ¯: ${decryptedMessagePacket.content}`, 'info');
                displayResult('e2e-result', `â° æ¶ˆæ¯æ—¶é—´æˆ³: ${new Date(decryptedMessagePacket.timestamp).toLocaleString()}`, 'info');
                
                if (messageContent === decryptedMessagePacket.content) {
                    displayResult('e2e-result', 'âœ… ç«¯åˆ°ç«¯åŠ å¯†é€šä¿¡å®Œæ•´æµç¨‹æµ‹è¯•æˆåŠŸï¼', 'success');
                } else {
                    displayResult('e2e-result', 'âŒ ç«¯åˆ°ç«¯åŠ å¯†é€šä¿¡å®Œæ•´æµç¨‹æµ‹è¯•å¤±è´¥', 'error');
                }
                
            } catch (error) {
                displayResult('e2e-result', `âŒ é”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function testPerformance() {
            clearResults('performance-result');
            try {
                displayResult('performance-result', 'âš¡ å¼€å§‹æ€§èƒ½æµ‹è¯•...', 'info');
                
                const testData = [
                    { size: 'çŸ­æ–‡æœ¬', content: 'Hello' },
                    { size: 'ä¸­ç­‰æ–‡æœ¬', content: 'Hello World! è¿™æ˜¯ä¸€æ¡æµ‹è¯•æ¶ˆæ¯ã€‚'.repeat(10) },
                    { size: 'é•¿æ–‡æœ¬', content: 'Hello World! è¿™æ˜¯ä¸€æ¡æµ‹è¯•æ¶ˆæ¯ã€‚'.repeat(100) }
                ];
                
                for (const test of testData) {
                    const startTime = performance.now();
                    
                    // å®Œæ•´çš„åŠ å¯†-éšå†™-è§£éšå†™-è§£å¯†æµç¨‹
                    const sessionKey = testManager.generateSessionKey('performance-test');
                    const encrypted = testManager.encryptText(test.content, sessionKey);
                    const stegoImage = await testManager.encodeTextInImage(encrypted);
                    const extracted = await testManager.decodeTextFromImage(stegoImage);
                    const decrypted = testManager.decryptText(extracted, sessionKey);
                    
                    const endTime = performance.now();
                    const duration = (endTime - startTime).toFixed(2);
                    
                    const success = test.content === decrypted;
                    const resultType = success ? 'success' : 'error';
                    const status = success ? 'âœ…' : 'âŒ';
                    
                    displayResult('performance-result', 
                        `${status} ${test.size} (${test.content.length}å­—ç¬¦): ${duration}ms`, 
                        resultType
                    );
                }
                
                displayResult('performance-result', 'âš¡ æ€§èƒ½æµ‹è¯•å®Œæˆ', 'info');
                
            } catch (error) {
                displayResult('performance-result', `âŒ æ€§èƒ½æµ‹è¯•é”™è¯¯: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œä¸€æ¬¡åŸºç¡€æµ‹è¯•
        window.onload = function() {
            setTimeout(() => {
                testRSAKeyGeneration();
            }, 500);
        };
    </script>
</body>
</html>
